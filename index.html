<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Panorama Galerisi</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #18255c; font-family: 'Segoe UI', sans-serif; color: white; }
        .header { height: 2cm; background: black; display: flex; align-items: center; padding: 0 1cm; }
        .settings-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; margin-right: 1cm; }
        .header-left { font-size: 1.5em; font-weight: bold; flex-grow: 1; }
        .header-right { font-size: 1.2em; }

        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5cm; padding: 1cm; }
        .grid-cell {
            background: rgba(255,255,255,0.1); border-radius: 8px; padding: 0.5cm; text-align: center;
            display: flex; flex-direction: column; justify-content: space-between; cursor: pointer;
            position: relative; transition: 0.2s; border: 2px dashed #555;
        }
        .grid-cell:hover { transform: scale(1.02); }
        .grid-cell.dropzone { border-color: #00ff88; background: rgba(0,255,136,0.1); }
        .grid-cell img { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; }
        .cell-number { font-weight: bold; color: #a0d8ff; margin: 0.3cm 0; }
        .cell-title { font-size: 0.9em; color: #ffdd88; }
        .folder-name { font-size: 0.8em; color: #a0d8ff; margin-top: 0.2cm; word-break: break-all; }
        .upload-area { padding: 0.5cm; font-size: 0.85em; color: #ccc; }
        .progress-container { height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin: 0.3cm 0; }
        .progress-bar { height: 100%; width: 0%; background: #28a745; transition: width 0.3s; }

        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.8); overflow: auto; }
        .modal-content { background: #1e2a44; margin: 5% auto; padding: 1.5cm; width: 90%; max-width: 1000px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 2em; cursor: pointer; color: #aaa; }
        .close:hover { color: white; }

        .page-modal { display: none; position: fixed; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1000px; height: 80vh; background: #0f1b36; border: 3px solid #0066cc; border-radius: 12px; box-shadow: 0 0 30px rgba(0,102,204,0.6); overflow: hidden; }
        .page-modal.fullscreen { inset: 0; width: 100vw; height: 100vh; border: none; border-radius: 0; transform: none; }
        .page-modal-header { background: #0066cc; color: white; padding: 0.4cm 0.8cm; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-controls { display: flex; gap: 0.5cm; }
        .modal-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 6px; cursor: pointer; font-size: 1.4em; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .modal-btn:hover { background: rgba(255,255,255,0.4); }
        .page-modal iframe { width: 100%; height: calc(100% - 50px); border: none; }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1cm; margin-top: 1cm; }
        .setting-item { background: rgba(255,255,255,0.1); padding: 0.8cm; border-radius: 8px; text-align: center; }
        .setting-item input[type="text"], .setting-item button { width: 100%; margin: 0.3cm 0; padding: 0.4cm; border: none; border-radius: 4px; }
        .setting-item input[type="text"] { background: #333; color: white; }
        .setting-item button { background: #0066cc; color: white; cursor: pointer; }
        .setting-item button:hover { background: #0088ff; }

        .load-export { display: flex; gap: 1cm; margin-top: 1cm; justify-content: center; flex-wrap: wrap; }
        .load-export button, .load-export label { padding: 0.5cm 1cm; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .load-export label:hover, .load-export button:hover { background: #0088ff; }
        .status { text-align: center; margin: 1cm 0; color: #a0d8ff; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="header">
        <button class="settings-btn" id="settingsBtn" title="Ayarlar">Settings</button>
        <div class="header-left">360 PANORAMA</div>
        <div class="header-right" id="datetime"></div>
    </div>

    <div class="grid-container" id="grid"></div>

    <!-- Ayarlar Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">x</span>
            <h2 style="text-align:center; color:#a0d8ff;">360 Panorama Ayarları</h2>
            <div class="status" id="statusMsg">Ayarlar yükleniyor...</div>
            <div class="load-export">
                <button id="saveToServerBtn">Sunucuya Kaydet</button>
                <button id="exportBtn">JSON Dışa Aktar</button>
                <label>JSON Yükle <input type="file" id="loadFile" accept=".json"></label>
            </div>
            <div class="settings-grid" id="settingsGrid"></div>
        </div>
    </div>

    <!-- Sayfa Modal -->
    <div id="pageModal" class="page-modal">
        <div class="page-modal-header">
            <span id="modalTitle">Panorama</span>
            <div class="modal-controls">
                <button class="modal-btn" id="maximizeBtn" title="Ekranı Kapla">+</button>
                <button class="modal-btn" id="fullscreenBtn" title="Tam Ekran">T</button>
                <button class="modal-btn" id="pageCloseBtn">x</button>
            </div>
        </div>
        <iframe id="pageIframe" src=""></iframe>
    </div>

    <script>
        const TOTAL_CELLS = 160;
        const SETTINGS_PATH = 'settings/360_settings.json';
        let settings = [];

        function getDefaultSettings() {
            return Array.from({ length: TOTAL_CELLS }, (_, i) => ({
                id: i + 1,
                image: 'assets/360.png',
                title: `Panorama ${i + 1}`,
                url: 'pages/placeholder.html',
                folder: ''
            }));
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('datetime').innerText = 
                `${now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit', second: '2-digit'})} - ${now.toLocaleDateString('tr-TR')}`;
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            settings.forEach((item, i) => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.index = i;

                cell.innerHTML = `
                    <img src="${item.image}" alt="${item.title}">
                    <div class="cell-number">${item.id}</div>
                    <div class="cell-title">${item.title}</div>
                    ${item.folder ? `<div class="folder-name">${item.folder}</div>` : ''}
                    <div class="upload-area">Sürükle veya Klasör Seç</div>
                    <div class="progress-container"><div class="progress-bar"></div></div>
                `;

                const dropArea = cell.querySelector('.upload-area');
                const progressBar = cell.querySelector('.progress-bar');

                setupDropZone(dropArea, progressBar, i, cell);

                cell.onclick = e => {
                    if (e.target.closest('.upload-area')) return;
                    openPageModal(item.url, item.title);
                };

                grid.appendChild(cell);
            });
        }

        function setupDropZone(area, progressBar, index, cell) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                area.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            area.addEventListener('dragenter', () => area.classList.add('dragover'));
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', e => {
                area.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length) uploadFolder(files, index, progressBar, cell);
            });

            area.onclick = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.webkitdirectory = true;
                input.onchange = e => {
                    if (e.target.files.length) uploadFolder(e.target.files, index, progressBar, cell);
                };
                input.click();
            };
        }

        async function uploadFolder(files, index, progressBar, cell) {
            const formData = new FormData();
            const folderName = files[0].webkitRelativePath.split('/')[0];
            formData.append('folder', folderName);

            for (let file of files) {
                formData.append('files[]', file, file.webkitRelativePath);
            }

            progressBar.style.width = '0%';
            cell.querySelector('.upload-area').innerText = 'Yükleniyor...';

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'upload.php', true);

                xhr.upload.onprogress = e => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressBar.style.width = percent + '%';
                    }
                };

                xhr.onload = () => {
                    const data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        // Sadece klasör adını kaydet
                        settings[index].folder = data.folder;
                        cell.innerHTML = cell.innerHTML.replace(
                            /<div class="folder-name">.*<\/div>/, 
                            `<div class="folder-name">${data.folder}</div>`
                        );
                        if (!cell.querySelector('.folder-name')) {
                            cell.insertAdjacentHTML('beforeend', `<div class="folder-name">${data.folder}</div>`);
                        }

                        saveToServer();
                        progressBar.style.width = '100%';
                        setTimeout(() => {
                            progressBar.style.width = '0%';
                            cell.querySelector('.upload-area').innerText = 'Sürükle veya Klasör Seç';
                        }, 1000);
                    } else {
                        alert('Hata: ' + (data.errors?.join(', ') || 'Bilinmeyen'));
                    }
                };

                xhr.send(formData);
            } catch (err) {
                alert('Yükleme hatası: ' + err.message);
            }
        }

        // Sayfa Modal
        const pageModal = document.getElementById('pageModal');
        const pageIframe = document.getElementById('pageIframe');
        const modalTitle = document.getElementById('modalTitle');
        let isMaximized = false;

        function openPageModal(url, title) {
            modalTitle.innerText = title;
            pageIframe.src = url;
            pageModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            isMaximized = false;
            document.getElementById('maximizeBtn').innerHTML = '+';
        }

        function closePageModal() {
            pageModal.style.display = 'none';
            pageIframe.src = '';
            document.body.style.overflow = 'auto';
            if (document.fullscreenElement) document.exitFullscreen();
        }

        document.getElementById('maximizeBtn').onclick = () => {
            isMaximized = !isMaximized;
            pageModal.style.width = isMaximized ? '95%' : '90%';
            pageModal.style.maxWidth = isMaximized ? 'none' : '1000px';
            pageModal.style.height = isMaximized ? '90vh' : '80vh';
            document.getElementById('maximizeBtn').innerHTML = isMaximized ? '-' : '+';
        };

        document.getElementById('fullscreenBtn').onclick = () => {
            if (!document.fullscreenElement) pageModal.requestFullscreen();
            else document.exitFullscreen();
        };

        document.getElementById('pageCloseBtn').onclick = closePageModal;
        document.addEventListener('fullscreenchange', () => {
            document.getElementById('fullscreenBtn').innerHTML = document.fullscreenElement ? 'O' : 'T';
        });

        // Ayarlar Modal
        const modal = document.getElementById('settingsModal');
        document.getElementById('settingsBtn').onclick = () => {
            renderSettingsModal();
            modal.style.display = 'block';
        };
        modal.querySelector('.close').onclick = () => modal.style.display = 'none';
        window.onclick = e => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === pageModal && !isMaximized) closePageModal();
        };

        function renderSettingsModal() {
            const container = document.getElementById('settingsGrid');
            container.innerHTML = '';
            settings.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'setting-item';

                div.innerHTML = `
                    <div style="font-weight:bold; color:#a0d8ff;">#${item.id}</div>
                    <input type="text" placeholder="Görsel Yolu (örn: pages/klasor/resim.jpg)" value="${item.image}" id="img${i}">
                    <input type="text" placeholder="Panorama Adı" value="${item.title}" id="title${i}">
                    <input type="text" placeholder="Sayfa Yolu (örn: pages/klasor/index.html)" value="${item.url}" id="url${i}">
                    ${item.folder ? `<div style="color:#a0d8ff; font-size:0.8em; margin:0.3cm 0;">Yüklü Klasör: <strong>${item.folder}</strong></div>` : ''}
                    <button>Kaydet</button>
                `;

                div.querySelector('button').onclick = () => {
                    settings[i].image = document.getElementById(`img${i}`).value.trim() || 'assets/360.png';
                    settings[i].title = document.getElementById(`title${i}`).value.trim() || `Panorama ${item.id}`;
                    settings[i].url = document.getElementById(`url${i}`).value.trim() || 'pages/placeholder.html';
                    saveToServer();
                    renderGrid();
                    alert(`#${item.id} kaydedildi!`);
                };

                container.appendChild(div);
            });
        }

        // Sunucu & Local
        async function loadFromServer() {
            try {
                const res = await fetch(SETTINGS_PATH + '?t=' + Date.now());
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data) && data.length === TOTAL_CELLS) {
                        settings = data;
                        saveToLocalStorage();
                        document.getElementById('statusMsg').innerHTML = '<span style="color:#28a745;">Sunucudan yüklendi.</span>';
                        renderGrid();
                        return true;
                    }
                }
            } catch (e) {}
            return false;
        }

        async function saveToServer() {
            try {
                await fetch(SETTINGS_PATH, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings, null, 2)
                });
            } catch (e) {}
        }

        function saveToLocalStorage() {
            localStorage.setItem('360_settings', JSON.stringify(settings));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('360_settings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length === TOTAL_CELLS) {
                        settings = parsed;
                        return true;
                    }
                } catch (e) {}
            }
            return false;
        }

        document.getElementById('exportBtn').onclick = () => {
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = '360_settings.json'; a.click();
            URL.revokeObjectURL(url);
        };

        document.getElementById('loadFile').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const loaded = JSON.parse(ev.target.result);
                    if (Array.isArray(loaded) && loaded.length === TOTAL_CELLS) {
                        settings = loaded;
                        saveToLocalStorage();
                        saveToServer();
                        renderGrid();
                        alert('Ayarlar yüklendi!');
                    } else alert('160 kutucuk olmalı.');
                } catch (err) { alert('JSON hatası'); }
            };
            reader.readAsText(file);
        };

        document.getElementById('saveToServerBtn').onclick = saveToServer;

        async function init() {
            settings = getDefaultSettings();
            loadFromLocalStorage();
            await loadFromServer();
            renderGrid();
        }
        init();
    </script>
</body>
</html>