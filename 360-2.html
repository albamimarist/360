<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Panorama Galerisi</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background-color: #18255c;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        .header {
            height: 2cm;
            background-color: black;
            display: flex;
            align-items: center;
            padding: 0 1cm;
            position: relative;
        }
        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            margin-right: 1cm;
            padding: 0.2cm;
        }
        .settings-btn:hover { opacity: 0.7; }
        .header-left { font-size: 1.5em; font-weight: bold; flex-grow: 1; }
        .header-right { font-size: 1.2em; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 0.5cm;
            padding: 1cm;
        }
        .grid-cell {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5cm;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s;
        }
        .grid-cell:hover { transform: scale(1.02); }
        .grid-cell a { display: block; margin-bottom: 0.5cm; }
        .grid-cell img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
        }
        .cell-number { font-weight: bold; color: #a0d8ff; margin: 0.3cm 0; }
        .cell-title { font-size: 0.9em; margin: 0.2cm 0; color: #ffdd88; }
        .share-button {
            padding: 0.25cm 0.5cm;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .share-button:hover { background-color: #555; }
        .url-display {
            margin-top: 0.3cm;
            background-color: #222;
            padding: 0.2cm;
            border-radius: 4px;
            font-size: 0.75em;
            word-break: break-all;
            cursor: pointer;
            color: #00ffcc;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }
        .modal-content {
            background-color: #1e2a44;
            margin: 5% auto;
            padding: 1.5cm;
            width: 90%;
            max-width: 1000px;
            border-radius: 12px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close { color: #aaa; float: right; font-size: 2em; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1cm;
            margin-top: 1cm;
        }
        .setting-item {
            background: rgba(255,255,255,0.1);
            padding: 0.8cm;
            border-radius: 8px;
            text-align: center;
        }
        .setting-item input, .setting-item button {
            width: 100%;
            margin: 0.3cm 0;
            padding: 0.4cm;
            border: none;
            border-radius: 4px;
        }
        .setting-item input { background: #333; color: white; }
        .setting-item button { background: #0066cc; color: white; cursor: pointer; }
        .setting-item button:hover { background: #0088ff; }

        .load-export {
            display: flex;
            gap: 1cm;
            margin-top: 1cm;
            justify-content: center;
            flex-wrap: wrap;
        }
        .load-export button, .load-export label {
            padding: 0.5cm 1cm;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
        }
        .load-export label:hover, .load-export button:hover { background: #0088ff; }
        .load-export input { display: none; }

        .status {
            text-align: center;
            margin: 1cm 0;
            font-size: 0.9em;
            color: #a0d8ff;
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="settings-btn" id="settingsBtn" title="Ayarlar">Settings</button>
        <div class="header-left">360 PANORAMA</div>
        <div class="header-right" id="datetime"></div>
    </div>

    <div class="grid-container" id="grid"></div>

    <!-- Ayarlar Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">x</span>
            <h2 style="text-align:center; color:#a0d8ff;">360 Panorama Ayarları</h2>
            <div class="status" id="statusMsg">Ayarlar yükleniyor...</div>
            <div class="load-export">
                <button id="saveToServerBtn">Sunucuya Kaydet</button>
                <button id="exportBtn">JSON Dışa Aktar</button>
                <label>
                    <input type="file" id="loadFile" accept=".json">
                    JSON Yükle
                </label>
            </div>
            <div class="settings-grid" id="settingsGrid"></div>
        </div>
    </div>

    <script>
        const TOTAL_CELLS = 160;
        const SETTINGS_PATH = 'settings/360_settings.json';
        let settings = [];

        // Varsayılan ayarlar
        function getDefaultSettings() {
            return Array.from({ length: TOTAL_CELLS }, (_, i) => ({
                id: i + 1,
                image: 'assets/360.png',
                title: `Panorama ${i + 1}`,
                url: 'pages/placeholder.html'
            }));
        }

        // Saat
        function updateDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('tr-TR');
            const time = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('datetime').innerText = `${time} - ${date}`;
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Grid Oluştur
        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            settings.forEach(item => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';

                const link = document.createElement('a');
                link.href = item.url;
                link.target = '_blank';
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.title;
                link.appendChild(img);
                cell.appendChild(link);

                const number = document.createElement('div');
                number.className = 'cell-number';
                number.innerText = item.id;
                cell.appendChild(number);

                const title = document.createElement('div');
                title.className = 'cell-title';
                title.innerText = item.title;
                cell.appendChild(title);

                const button = document.createElement('button');
                button.className = 'share-button';
                button.innerText = 'URL Paylaş';
                button.onclick = function(e) {
                    e.stopPropagation();
                    const disp = cell.querySelector('.url-display');
                    if (disp) {
                        disp.remove();
                        button.innerText = 'URL Paylaş';
                    } else {
                        const urlDisp = document.createElement('div');
                        urlDisp.className = 'url-display';
                        urlDisp.innerText = item.url;
                        urlDisp.onclick = () => {
                            navigator.clipboard.writeText(item.url).then(() => {
                                alert('Kopyalandı: ' + item.url);
                            });
                        };
                        cell.appendChild(urlDisp);
                        button.innerText = 'Gizle';
                    }
                };
                cell.appendChild(button);

                grid.appendChild(cell);
            });
        }

        // Ayarlar Modal
        const modal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeBtn = document.querySelector('.close');
        const statusMsg = document.getElementById('statusMsg');

        settingsBtn.onclick = () => {
            renderSettingsModal();
            modal.style.display = 'block';
        };
        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

        function renderSettingsModal() {
            const container = document.getElementById('settingsGrid');
            container.innerHTML = '';
            settings.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'setting-item';

                div.innerHTML = `
                    <div style="font-weight:bold; color:#a0d8ff;">#${item.id}</div>
                    <input type="text" placeholder="Görsel URL" value="${item.image}">
                    <input type="text" placeholder="Başlık" value="${item.title}">
                    <input type="text" placeholder="Sayfa URL" value="${item.url}">
                    <button>Kaydet</button>
                `;

                const inputs = div.querySelectorAll('input');
                const btn = div.querySelector('button');
                btn.onclick = () => {
                    settings[i] = {
                        id: item.id,
                        image: inputs[0].value.trim() || 'assets/360.png',
                        title: inputs[1].value.trim() || `Panorama ${item.id}`,
                        url: inputs[2].value.trim() || 'pages/placeholder.html'
                    };
                    saveToLocalStorage();
                    saveToServer(); // Otomatik sunucuya kaydet
                    renderGrid();
                    alert(`#${item.id} kaydedildi!`);
                };

                container.appendChild(div);
            });
        }

        // Sunucudan yükle
        async function loadFromServer() {
            try {
                const res = await fetch(SETTINGS_PATH + '?t=' + Date.now());
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data) && data.length === TOTAL_CELLS) {
                        settings = data;
                        saveToLocalStorage();
                        statusMsg.innerHTML = '<span style="color:#28a745;">Ayarlar sunucudan yüklendi.</span>';
                        renderGrid();
                        return true;
                    }
                }
            } catch (err) {
                console.log('Sunucudan yükleme hatası:', err);
            }
            return false;
        }

        // Sunucuya kaydet (PUT ile)
        async function saveToServer() {
            try {
                const res = await fetch(SETTINGS_PATH, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings, null, 2)
                });
                if (res.ok) {
                    statusMsg.innerHTML = '<span style="color:#28a745;">Ayarlar sunucuya kaydedildi.</span>';
                } else {
                    statusMsg.innerHTML = '<span style="color:#ff6b6b;">Sunucuya kaydedilemedi (PUT desteklenmiyor).</span>';
                }
            } catch (err) {
                statusMsg.innerHTML = '<span style="color:#ffcc00;">Sunucuya kaydedilemedi (çevrimdışı).</span>';
            }
        }

        // localStorage
        function saveToLocalStorage() {
            localStorage.setItem('360_settings', JSON.stringify(settings));
        }
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('360_settings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length === TOTAL_CELLS) {
                        settings = parsed;
                        return true;
                    }
                } catch (e) {}
            }
            return false;
        }

        // Dışa aktar
        document.getElementById('exportBtn').onclick = () => {
            const data = JSON.stringify(settings, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '360_settings.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        // JSON Yükle
        document.getElementById('loadFile').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const loaded = JSON.parse(ev.target.result);
                    if (Array.isArray(loaded) && loaded.length === TOTAL_CELLS) {
                        settings = loaded;
                        saveToLocalStorage();
                        saveToServer();
                        renderGrid();
                        alert('Ayarlar yüklendi!');
                    } else {
                        alert('Geçersiz dosya: 160 kutucuk olmalı.');
                    }
                } catch (err) {
                    alert('JSON okunamadı: ' + err.message);
                }
            };
            reader.readAsText(file);
        };

        // Sunucuya kaydet butonu
        document.getElementById('saveToServerBtn').onclick = saveToServer;

        // Başlat
        async function init() {
            settings = getDefaultSettings(); // Varsayılan

            // 1. localStorage'dan yükle
            if (loadFromLocalStorage()) {
                statusMsg.innerHTML = 'Ayarlar yerel depodan yüklendi.';
            }

            // 2. Sunucudan yükle (üzerine yazar)
            const serverLoaded = await loadFromServer();
            if (!serverLoaded) {
                statusMsg.innerHTML = '<span style="color:#ffcc00;">Sunucudan ayar bulunamadı, varsayılan kullanılıyor.</span>';
            }

            renderGrid();
        }

        init();
    </script>
</body>
</html>